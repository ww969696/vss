<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>VSS Patrol App</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Roboto', sans-serif;
      background-color: #f2f2f2;
      color: #222;
      user-select: none;
    }

    .status-bar {
      background-color: #e0e0e0;
      color: #333;
      padding: 4px 10px;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .app-bar {
      background-color: #f9f9f9;
      padding: 10px;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      border-bottom: 1px solid #ccc;
    }

    .nav-bar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background-color: #eaeaea;
      display: flex;
      justify-content: space-around;
      padding: 10px 0;
      border-top: 1px solid #ccc;
    }

    .nav-bar button {
      background: none;
      border: none;
      color: #333;
      font-size: 18px;
    }

    .content {
      padding: 15px;
      padding-bottom: 70px;
    }

    button {
      background-color: #ddd;
      border: 1px solid #bbb;
      padding: 10px 14px;
      border-radius: 6px;
      color: #222;
      font-size: 15px;
      margin: 8px 0;
      width: 100%;
    }

    input, select, textarea {
      width: 100%;
      padding: 8px;
      margin-top: 6px;
      margin-bottom: 12px;
      border-radius: 4px;
      border: 1px solid #bbb;
      background-color: #fff;
      color: #111;
      font-size: 14px;
    }

    .entry {
      padding: 10px;
      margin-bottom: 10px;
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .entry .ts {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
    }

    .notify {
      background-color: #ffecb3;
      color: #111;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .panic-banner {
      background-color: red;
      color: white;
      text-align: center;
      padding: 6px;
      font-weight: bold;
      display: none;
    }

    .overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(255, 0, 0, 0.4);
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <div class="status-bar">
    <span id="time">--:--</span>
    <span>üîã 75%</span>
  </div>

  <div id="panicBanner" class="panic-banner">üö® GUARD IN PANIC MODE ‚Äî ACTION REQUIRED</div>
  <div id="app" class="content">Loading...</div>

  <div class="nav-bar">
    <button id="btnBack">‚óÄ</button>
    <button id="btnHome">üè†</button>
    <button id="btnMenu">‚ò∞</button>
  </div>

  <div class="overlay" id="flashOverlay"></div>
  <script>
  // Firebase refs are loaded via firebase-config.js
  let currentUser = "";
  let currentStatus = "Active";
  let currentScreen = "login";
  let screenStack = [];

  const app = document.getElementById("app");
  const panicBanner = document.getElementById("panicBanner");
  const flashOverlay = document.getElementById("flashOverlay");

  // Update clock every second
  setInterval(() => {
    document.getElementById("time").innerText = new Date().toLocaleTimeString();
  }, 1000);

  // Navigation
  function showScreen(html) {
    app.innerHTML = html;
  }

  function goHome() {
    screenStack = [];
    homeScreen();
  }

  function goBack() {
    if (screenStack.length > 0) {
      const prev = screenStack.pop();
      prev();
    }
  }

  function pushScreen(fn) {
    screenStack.push(fn);
  }

  document.getElementById("btnHome").onclick = goHome;
  document.getElementById("btnBack").onclick = goBack;
  document.getElementById("btnMenu").onclick = goHome;

  // Login
  function loginScreen() {
    showScreen(`
      <h2>Welcome to VSS</h2>
      <p>Enter your name:</p>
      <input id="loginName" placeholder="Guard Name" />
      <button onclick="handleLogin()">Login</button>
    `);
  }

  function handleLogin() {
    const name = document.getElementById("loginName").value.trim();
    if (!name) return inAppNotify("Please enter a name.");
    currentUser = name;
    guardsRef.child(name).set({
      status: "Active",
      lastSeen: now(),
      location: "Logged In"
    });
    homeScreen();
  }

  function now() {
    return new Date().toLocaleString();
  }

  function homeScreen() {
    currentScreen = "home";
    showScreen(`
      <h2>Main Menu</h2>
      <button onclick="patrolScreen()">üö∂ Patrol</button>
      <button onclick="reportScreen()">üìù Submit Report</button>
      <button onclick="messageScreen()">üìã Message Board</button>
      <button onclick="triggerPanic()">üö® Panic</button>
      <button onclick="statusScreen()">üßç Set Status</button>
    `);
  }
</script>
<script>
  function patrolScreen() {
    pushScreen(homeScreen);
    showScreen(`
      <h3>Patrol</h3>
      <label>Location:</label>
      <select id="site">
        <option value="VGH">Vancouver General Hospital</option>
        <option value="PowerPlant">Vancouver Power Plant</option>
        <option value="FamilyJewels">Family Jewels Outlet</option>
        <option value="TD">TD Bank</option>
        <option value="GasGo">Gas & Go</option>
        <option value="ThreeGuys">Three Guys Corp</option>
        <option value="Fortis">Fortis Gas Depot</option>
        <option value="CanadaPost">Canada Post</option>
        <option value="LakeHOA">Lake View HOA</option>
        <option value="MapleBIA">Maple Street BIA</option>
      </select>
      <label>Route:</label>
      <select id="route">
        <option value="Outdoor">Outdoor</option>
        <option value="Indoor">Indoor</option>
      </select>
      <button onclick="scanTag()">üìç Scan Tag</button>
    `);
  }

  function scanTag() {
    const site = document.getElementById("site").value;
    const route = document.getElementById("route").value;
    const tag = prompt("Enter tag number (1-10)");
    if (!tag) return;

    const entry = {
      type: "scan",
      user: currentUser,
      site,
      route,
      tag,
      time: now()
    };
    logsRef.push(entry);
    inAppNotify("‚úÖ Tag scanned: " + tag);
  }

  function reportScreen() {
    pushScreen(homeScreen);
    showScreen(`
      <h3>Submit Report</h3>
      <label>Type:</label>
      <select id="reportType">
        <option value="Hazard">Hazard</option>
        <option value="Incident">Incident</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Other">Other</option>
      </select>
      <label>Description:</label>
      <textarea id="reportDesc" rows="4" placeholder="What happened?"></textarea>
      <button onclick="submitReport()">Submit</button>
    `);
  }

  function submitReport() {
    const type = document.getElementById("reportType").value;
    const desc = document.getElementById("reportDesc").value.trim();
    if (!desc) return inAppNotify("Please provide a description.");
    const entry = {
      type: "report",
      user: currentUser,
      reportType: type,
      description: desc,
      time: now()
    };
    logsRef.push(entry);
    inAppNotify("üìã Report submitted.");
    goHome();
  }

  function messageScreen() {
    pushScreen(homeScreen);
    logsRef.once("value", snap => {
      let html = `<h3>Message Board</h3>`;
      const entries = snap.val();
      for (let key in entries) {
        const e = entries[key];
        html += `<div class="entry">
          <strong>${e.user}</strong>: ${
            e.type === "scan" ? `scanned Tag ${e.tag} at ${e.site} (${e.route})` :
            e.type === "report" ? `submitted a ${e.reportType} report: "${e.description}"` :
            e.type === "panic" ? `üö® PANIC issued from ${e.location}` :
            e.type === "checkin" ? `‚úÖ Responded to check-in` :
            e.type === "alarm" ? `üîî ${e.description}` : "Unknown"
          }
          <div class="ts">${e.time}</div>
        </div>`;
      }
      showScreen(html);
    });
  }

  function triggerPanic() {
    const location = prompt("Enter your current location:");
    flashOverlay.style.display = "block";
    setTimeout(() => flashOverlay.style.display = "none", 1500);

    const entry = {
      type: "panic",
      user: currentUser,
      location,
      time: now()
    };
    logsRef.push(entry);
    guardsRef.child(currentUser).update({ status: "Panic", lastSeen: now(), location });
    panicBanner.style.display = "block";
    inAppNotify("üö® Panic alert sent.");
  }

  function statusScreen() {
    pushScreen(homeScreen);
    showScreen(`
      <h3>Set Status</h3>
      <select id="statusSelect">
        <option value="Active">Active</option>
        <option value="Armoured Transport">Armoured Transport</option>
        <option value="Break">Break</option>
      </select>
      <label>Location:</label>
      <input id="statusLoc" placeholder="Where are you?" />
      <button onclick="updateStatus()">Update</button>
    `);
  }

  function updateStatus() {
    const status = document.getElementById("statusSelect").value;
    const location = document.getElementById("statusLoc").value.trim();
    currentStatus = status;
    guardsRef.child(currentUser).update({
      status,
      lastSeen: now(),
      location
    });
    if (status !== "Panic") panicBanner.style.display = "none";
    inAppNotify("‚úÖ Status updated.");
    goHome();
  }
</script>
  <script>
  // Random simulated alarms
  const simulatedAlarms = [
    "Suspicious customer near entrance.",
    "Residential alarm at loading dock.",
    "Loitering near fence line.",
    "Loud noise reported in stairwell.",
    "Unauthorized person in restricted zone."
  ];

  function simulateAlarm() {
    const msg = simulatedAlarms[Math.floor(Math.random() * simulatedAlarms.length)];
    const entry = {
      type: "alarm",
      user: "System",
      description: msg,
      time: now()
    };
    logsRef.push(entry);
    inAppNotify("üîî " + msg);
  }

  // Check-in system
  const checkInInterval = 5 * 60 * 1000; // 5 min

  function startCheckInCycle() {
    setInterval(() => {
      if (currentStatus === "Panic") return; // skip if panicking
      const checkTime = Date.now();
      const promptId = "check_" + checkTime;

      inAppNotify("Check-in required.", "‚úÖ Check In", () => {
        const entry = {
          type: "checkin",
          user: currentUser,
          time: now()
        };
        logsRef.push(entry);
      });

      setTimeout(() => {
        if (currentStatus !== "Panic") {
          triggerPanic();
        }
      }, 60000); // escalate after 1 min if unacknowledged
    }, checkInInterval);
  }

  // Reset via URL
  function checkReset() {
    const url = new URL(window.location.href);
    if (url.searchParams.get("reset") === "true") {
      logsRef.remove();
      inAppNotify("System logs cleared.");
    }
  }

  // In-app notification helper
  function inAppNotify(msg, actionText = null, action = null) {
    const note = document.createElement("div");
    note.className = "notify";
    note.innerHTML = msg;
    if (actionText && action) {
      const btn = document.createElement("button");
      btn.textContent = actionText;
      btn.style.marginTop = "10px";
      btn.onclick = () => {
        action();
        note.remove();
      };
      note.appendChild(btn);
    }
    app.prepend(note);
    setTimeout(() => note.remove(), 10000);
  }

  // Page load logic
  window.onload = () => {
    loginScreen();
    checkReset();
    setInterval(simulateAlarm, Math.random() * 180000 + 180000); // random 3‚Äì6 min
    startCheckInCycle();
  };
</script>
  </body>
</html>
