<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VSS Patrol App</title>
<style>
  @import url('https://fonts.googleapis.com/css?family=Roboto:400,500');

  * {
    box-sizing: border-box;
  }
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: 'Roboto', sans-serif;
    background: #e0e0e0;
    color: #222;
    user-select: none;
  }

  #device {
    width: 360px;
    max-width: 100vw;
    height: 640px;
    max-height: 90vh;
    border: 2px solid #555;
    border-radius: 16px;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
    background: #f4f4f4;
    box-shadow:
      inset 0 0 10px #aaa,
      0 10px 30px rgba(0,0,0,0.3);
    display: flex;
    flex-direction: column;
  }

  /* Status bar */
  .status-bar {
    height: 24px;
    background: #333;
    color: #bbb;
    padding: 0 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    text-shadow: 0 1px 0 #000;
    font-weight: 500;
    font-family: monospace;
    user-select: none;
  }

  /* Screen container */
  #screen {
    flex: 1;
    background: #fafafa;
    color: #222;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* App bar */
  .app-bar {
    background: #3a5998;
    padding: 12px 16px;
    color: #fff;
    font-weight: 600;
    font-size: 18px;
    text-shadow: 0 1px 2px #000a;
    letter-spacing: 0.03em;
    box-shadow: inset 0 -2px 4px #2c4674;
    user-select: none;
  }

  /* Content scroll area */
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 12px 16px;
    font-size: 14px;
  }

  /* Navigation bar */
  .nav-bar {
    height: 56px;
    background: #222;
    display: flex;
    box-shadow: inset 0 1px 0 #444;
  }
  .nav-bar button {
    flex: 1;
    border: none;
    background: #222;
    color: #ccc;
    font-size: 24px;
    outline: none;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    font-weight: 700;
  }
  .nav-bar button:active {
    background: #555;
    color: #eee;
  }

  /* Home grid */
  .home-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    margin-top: 10px;
  }
  .app-icon {
    background: #fafafa;
    border: 1px solid #999;
    border-radius: 14px;
    height: 90px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 20px;
    box-shadow: 0 1px 4px #bbb;
    cursor: pointer;
    user-select: none;
    font-weight: 600;
    transition: background 0.15s ease;
  }
  .app-icon:hover,
  .app-icon:focus {
    background: #d9e3f0;
    outline: none;
  }

  /* Forms */
  input, select, textarea, button {
    font-family: 'Roboto', sans-serif;
    font-size: 14px;
  }
  input, select, textarea {
    width: 100%;
    margin: 8px 0 12px;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1.5px solid #aaa;
    outline: none;
    transition: border-color 0.3s ease;
    color: #111;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #3a5998;
    box-shadow: 0 0 8px #3a5998aa;
  }
  button {
    background: #3a5998;
    color: white;
    border: none;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    box-shadow: 0 3px 8px #30518c;
    user-select: none;
  }
  button:disabled {
    background: #888;
    cursor: not-allowed;
    box-shadow: none;
  }
  button:active:not(:disabled) {
    background: #2a3f6d;
  }

  /* Notifications */
  .notify {
    background: #ffeb3b;
    color: #111;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 0 6px #c1b702;
    user-select: none;
  }

  /* Message board */
  .message-board .entry {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px 14px;
    margin-bottom: 14px;
    font-size: 13px;
    color: #222;
    box-shadow: 0 1px 5px #bbb;
  }
  .message-board .entry strong {
    display: block;
    font-size: 14px;
    margin-bottom: 4px;
    color: #3a5998;
    user-select: text;
  }
  .message-board .entry .ts {
    opacity: 0.6;
    font-size: 11px;
    margin-top: 6px;
    font-family: monospace;
    user-select: text;
  }

  /* Scrollbar styling */
  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #eee;
  }
  ::-webkit-scrollbar-thumb {
    background-color: #3a5998;
    border-radius: 20px;
    border: 3px solid #eee;
  }

  /* Modal overlay */
  #modalOverlay {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.5);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }
  #modal {
    background: #fff;
    border-radius: 12px;
    max-width: 320px;
    width: 90%;
    padding: 20px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    font-size: 14px;
    color: #222;
  }
  #modal h2 {
    margin-top: 0;
    font-weight: 700;
    color: #3a5998;
    text-align: center;
  }
  #modal p {
    margin: 12px 0;
    line-height: 1.4;
  }
  #modal input[type="text"],
  #modal textarea {
    width: 100%;
    padding: 8px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1.5px solid #aaa;
    font-size: 14px;
    resize: vertical;
  }
  #modalButtons {
    margin-top: 20px;
    display: flex;
    justify-content: flex-end;
    gap: 12px;
  }
  #modalButtons button {
    background: #3a5998;
    color: white;
    border: none;
    padding: 8px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    box-shadow: 0 3px 8px #30518c;
    user-select: none;
  }
  #modalButtons button.cancel {
    background: #aaa;
    box-shadow: none;
  }
  #modalButtons button.cancel:active {
    background: #888;
  }

</style>
</head>
<body>

<div id="device" role="main" aria-label="VSS Patrol App">
  <div class="status-bar" aria-live="polite" aria-atomic="true" aria-relevant="text">
    <div class="left" id="statusTime">--:--</div>
    <div class="right">üîã 85%</div>
  </div>
  <div id="screen">
    <div id="app" tabindex="0"></div>
  </div>
  <div class="nav-bar" role="navigation" aria-label="Navigation Buttons">
    <button id="btnBack" aria-label="Back">‚óÄ</button>
    <button id="btnHome" aria-label="Home">‚è∫</button>
    <button id="btnMenu" aria-label="Menu">‚ò∞</button>
  </div>
</div>

<!-- Modal container -->
<div id="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
  <div id="modal">
    <h2 id="modalTitle"></h2>
    <p id="modalDesc"></p>
    <div id="modalInputs"></div>
    <div id="modalButtons"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
(() => {
  // Firebase configuration ‚Äî replace with your actual config if different
  const firebaseConfig = {
    apiKey: "AIzaSyCyQWxW-3gsvN7zI4YYIVw1sUVOreBCdbc",
    authDomain: "project-be13b.firebaseapp.com",
    databaseURL: "https://project-be13b-default-rtdb.firebaseio.com",
    projectId: "project-be13b",
    storageBucket: "project-be13b.firebasestorage.app",
    messagingSenderId: "724859412186",
    appId: "1:724859412186:web:2a5ef9d65d7c307c870fe3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const logsRef = db.ref("logs");
  const guardsRef = db.ref("guards");

  // Variables
  const appEl = document.getElementById('app');
  const btnBack = document.getElementById('btnBack');
  const btnHome = document.getElementById('btnHome');
  const btnMenu = document.getElementById('btnMenu');
  const statusTimeEl = document.getElementById('statusTime');

  const CONTRACT_SITES = [
    {name: "Vancouver General Hospital", code:"VGH"},
    {name: "Vancouver Power Plant", code:"Power Plant"},
    {name: "Family Jewels & Gadget Store", code:"FJGS"},
    {name: "Toronto Dominion Bank", code:"TDB"},
    {name: "Gas & Go Franchises", code:"Gas & Go"},
    {name: "Three Guys Corporation", code:"Three Guys"},
    {name: "Fortis BC Gas Depot", code:"Fortis BC"},
    {name: "Canada Post Corporation", code:"Canada Post"},
    {name: "Lake View HOA", code:"HOA"},
    {name: "Maple Street BIA", code:"BIA"}
  ];

  const PATROL_TYPES = ['Outdoor', 'Indoor'];

  const TAGS = {
    Outdoor: ["Tag 1", "Tag 2", "Tag 3", "Tag 4", "Tag 5"],
    Indoor: ["Tag 6", "Tag 7", "Tag 8", "Tag 9", "Tag 10"]
  };

  const ALARM_MSGS = [
    "Motion detected near Loading Dock",
    "Unauthorized entry at Main Gate",
    "Suspicious package detected near Parking Lot",
    "Graffiti reported near building wall",
    "Flood sensor triggered in basement",
    "Fire alarm test in Lobby",
    "Camera offline at East Corridor"
  ];

  let logs = [];  // Array of all log entries, synced with Firebase
  let notifications = [];
  let screenStack = [];

  let alarmTimer = null;
  let checkinTimer = null;

  // Modal elements
  const modalOverlay = document.getElementById('modalOverlay');
  const modalTitle = document.getElementById('modalTitle');
  const modalDesc = document.getElementById('modalDesc');
  const modalInputs = document.getElementById('modalInputs');
  const modalButtons = document.getElementById('modalButtons');

  // Utility: Show modal dialog (title, message, inputs HTML, buttons array)
  // buttons: [{text:"OK",class:"",handler:function},...]
  function showModal(title, desc, inputsHtml, buttons){
    modalTitle.textContent = title;
    modalDesc.textContent = desc;
    modalInputs.innerHTML = inputsHtml || '';
    modalButtons.innerHTML = '';
    buttons.forEach(btn=>{
      const b = document.createElement('button');
      b.textContent = btn.text;
      if(btn.class) b.classList.add(btn.class);
      b.onclick = () => {
        hideModal();
        btn.handler();
      };
      modalButtons.appendChild(b);
    });
    modalOverlay.style.display = 'flex';
    // Focus first input if any
    const firstInput = modalInputs.querySelector('input, textarea, select, button');
    if(firstInput) firstInput.focus();
  }
  function hideModal(){
    modalOverlay.style.display = 'none';
  }

  // Save logs locally and sync to Firebase
  function saveLogs(){
    localStorage.setItem('logs', JSON.stringify(logs));
    // Sync to firebase
    logsRef.set(logs);
  }

  // Add new log entry and update UI + sync
  function addLog(type, user, text){
    const entry = {type, user, text, ts: new Date().toISOString()};
    logs.unshift(entry);
    saveLogs();
    notify(`New log: ${type.toUpperCase()}`);
    // Update message board if visible
    if(screenStack.length && screenStack[screenStack.length-1] === messageScreen){
      renderMessages();
    }
  }

  // Show notification banner inside app
  function notify(msg){
    notifications.unshift(msg);
    const n = document.createElement('div');
    n.className = 'notify';
    n.innerText = msg;
    appEl.insertBefore(n, appEl.firstChild);
    setTimeout(() => n.remove(), 6000);
  }

  // Show a screen by pushing function onto stack
  function showScreen(screenFunc){
    screenStack.push(screenFunc);
    screenFunc();
  }

  // Go back to previous screen
  function goBack(){
    if(screenStack.length > 1){
      screenStack.pop();
      const prev = screenStack[screenStack.length -1];
      prev();
    }
  }

  // Go home - reset stack to just home screen
  function goHome(){
    screenStack.splice(1);
    if(screenStack.length===0) screenStack.push(homeScreen);
    screenStack[0]();
  }

  // UI Update for status time every second
  setInterval(() => {
    const now = new Date();
    statusTimeEl.textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }, 1000);

  // --- Screen: Login ---
  function loginScreen(){
    appEl.innerHTML = `
      <div class="app-bar">Login</div>
      <div class="content">
        <input id="username" placeholder="Guard name or ID" autocomplete="off" aria-label="Enter guard name or ID" />
        <button id="loginBtn" disabled>Login</button>
      </div>
    `;
    const input = document.getElementById('username');
    const btn = document.getElementById('loginBtn');
    input.focus();
    input.addEventListener('input', () => {
      btn.disabled = input.value.trim().length === 0;
    });
    btn.onclick = () => {
      const user = input.value.trim();
      if(user){
        localStorage.setItem('user', user);
        if(!localStorage.getItem('patrolSite')) localStorage.setItem('patrolSite', CONTRACT_SITES[0].code);
        if(!localStorage.getItem('patrolType')) localStorage.setItem('patrolType', 'Outdoor');
        // Register guard presence to Firebase
        guardsRef.child(user).set({
          lastActive: new Date().toISOString(),
          status: 'On Duty'
        });
        showScreen(homeScreen);
      }
    };
  }

  // --- Screen: Home ---
  function homeScreen(){
    const user = localStorage.getItem('user') || 'Unknown Guard';
    appEl.innerHTML = `
      <div class="app-bar">VSS Patrol Home</div>
      <div class="content">
        <div><strong>Hello, ${user}</strong></div>
        <div class="home-grid" role="list" aria-label="Main navigation">
          <div role="listitem" tabindex="0" class="app-icon" id="openPatrol">üõ∞Ô∏è Patrol</div>
          <div role="listitem" tabindex="0" class="app-icon" id="openMessages">üí¨ Message Board</div>
          <div role="listitem" tabindex="0" class="app-icon" id="openReports">üìù Reports</div>
          <div role="listitem" tabindex="0" class="app-icon" id="openStatus">üëÆ Guard Status</div>
        </div>
      </div>
    `;

    document.getElementById('openPatrol').onclick = () => showScreen(patrolScreen);
    document.getElementById('openMessages').onclick = () => showScreen(messageScreen);
    document.getElementById('openReports').onclick = () => showScreen(reportScreen);
    document.getElementById('openStatus').onclick = () => showScreen(statusScreen);

    // Keyboard accessibility
    ['openPatrol','openMessages','openReports','openStatus'].forEach(id => {
      const el = document.getElementById(id);
      el.onkeypress = e => {
        if(e.key === 'Enter' || e.key === ' ') el.click();
      };
    });
  }

  // --- Screen: Patrol ---
  function patrolScreen(){
    const user = localStorage.getItem('user') || 'Unknown Guard';
    const patrolSite = localStorage.getItem('patrolSite') || CONTRACT_SITES[0].code;
    const patrolType = localStorage.getItem('patrolType') || 'Outdoor';
    const tags = TAGS[patrolType] || [];

    let tagButtonsHtml = tags.map(t => `<button class="tag-btn" data-tag="${t}">${t}</button>`).join('');

    let patrolSiteOptions = CONTRACT_SITES.map(site =>
      `<option value="${site.code}" ${site.code === patrolSite ? 'selected' : ''}>${site.name}</option>`).join('');

    let patrolTypeOptions = PATROL_TYPES.map(pt =>
      `<option value="${pt}" ${pt === patrolType ? 'selected' : ''}>${pt}</option>`).join('');

    appEl.innerHTML = `
      <div class="app-bar">Patrol</div>
      <div class="content">
        <label for="siteSelect">Patrol Site:</label>
        <select id="siteSelect" aria-label="Select patrol site">${patrolSiteOptions}</select>

        <label for="patrolTypeSelect">Patrol Type:</label>
        <select id="patrolTypeSelect" aria-label="Select patrol type">${patrolTypeOptions}</select>

        <div><strong>Tap a tag to scan:</strong></div>
        <div id="tagButtons" style="display:flex; flex-wrap: wrap; gap: 10px; margin-top: 8px;">
          ${tagButtonsHtml}
        </div>

        <button id="btnPanic" style="margin-top: 20px; background:#d93025;">‚ö†Ô∏è Panic Alert</button>
      </div>
    `;

    document.getElementById('siteSelect').onchange = e => {
      localStorage.setItem('patrolSite', e.target.value);
    };

    document.getElementById('patrolTypeSelect').onchange = e => {
      localStorage.setItem('patrolType', e.target.value);
      // Reload patrolScreen to update tags
      patrolScreen();
    };

    // Tag scan handler
    document.querySelectorAll('.tag-btn').forEach(btn => {
      btn.onclick = () => {
        const tag = btn.dataset.tag;
        addLog('scan', user, `Scanned ${tag} at site ${localStorage.getItem('patrolSite') || 'Unknown'}`);
      };
    });

    document.getElementById('btnPanic').onclick = () => {
      showPanicModal(user);
    };
  }

  // --- Modal: Panic alert ---
  function showPanicModal(user){
    showModal(
      "Panic Alert",
      "Please describe your current location and situation:",
      `<textarea id="panicInput" rows="4" placeholder="E.g. Near main entrance, suspect running"></textarea>`,
      [
        {
          text: "Send Panic",
          handler: () => {
            const desc = document.getElementById('panicInput').value.trim();
            if(!desc){
              notify("Panic alert requires a description!");
              showPanicModal(user);
              return;
            }
            addLog('panic', user, desc);
            notify("Panic alert sent!");
          }
        },
        {
          text: "Cancel",
          class: "cancel",
          handler: () => {
            /* do nothing */
          }
        }
      ]
    );
  }

  // --- Screen: Message Board ---
  function messageScreen(){
    appEl.innerHTML = `
      <div class="app-bar">Message Board</div>
      <div class="content message-board" id="messagesDiv" tabindex="0" aria-label="Message board logs">
      </div>
    `;

    renderMessages();
  }

  // Render all logs in message board with icons and formatting
  function renderMessages(){
    const messagesDiv = document.getElementById('messagesDiv');
    if(!messagesDiv) return;
    messagesDiv.innerHTML = '';

    logs.forEach(log => {
      const entry = document.createElement('div');
      entry.className = 'entry';
      const ts = new Date(log.ts);
      let prefix = '';
      switch(log.type){
        case 'message':
          prefix = `<strong>${escapeHtml(log.user)}</strong>: `;
          break;
        case 'scan':
          prefix = `üìç <em>${escapeHtml(log.user)}</em> scanned: `;
          break;
        case 'report':
          prefix = `üìù <em>${escapeHtml(log.user)}</em> report: `;
          break;
        case 'panic':
          prefix = `‚ùó <em>${escapeHtml(log.user)}</em> PANIC: `;
          break;
        case 'alarm':
          prefix = `üö® Alarm: `;
          break;
        case 'alert':
          prefix = `‚ö†Ô∏è Alert: `;
          break;
        default:
          prefix = '';
      }
      entry.innerHTML = `${prefix}${escapeHtml(log.text)}<div class="ts">${ts.toLocaleString()}</div>`;
      messagesDiv.appendChild(entry);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  // --- Screen: Reports ---
  // (Shows only reports for now, but can be expanded)
  function reportScreen(){
    appEl.innerHTML = `
      <div class="app-bar">Reports</div>
      <div class="content message-board" id="reportsDiv" tabindex="0" aria-label="Reports logs">
      </div>
    `;

    const reportsDiv = document.getElementById('reportsDiv');
    reportsDiv.innerHTML = '';

    const reports = logs.filter(l => l.type === 'report');
    if(reports.length === 0){
      reportsDiv.innerHTML = '<p>No reports submitted yet.</p>';
      return;
    }

    reports.forEach(log => {
      const entry = document.createElement('div');
      entry.className = 'entry';
      const ts = new Date(log.ts);
      entry.innerHTML = `üìù <strong>${escapeHtml(log.user)}</strong>: ${escapeHtml(log.text)}<div class="ts">${ts.toLocaleString()}</div>`;
      reportsDiv.appendChild(entry);
    });
  }

  // --- Screen: Guard Status ---
  // Shows guards currently online with last activity and status
  function statusScreen(){
    appEl.innerHTML = `
      <div class="app-bar">Guard Status</div>
      <div class="content" id="guardStatusList" tabindex="0" aria-label="List of guards and status"></div>
    `;

    const list = document.getElementById('guardStatusList');
    list.innerHTML = '<p>Loading guard status...</p>';

    guardsRef.once('value').then(snapshot => {
      const guards = snapshot.val();
      list.innerHTML = '';
      if(!guards){
        list.innerHTML = '<p>No guard data found.</p>';
        return;
      }
      const now = Date.now();
      Object.entries(guards).forEach(([guard, data]) => {
        let lastActive = data.lastActive ? new Date(data.lastActive) : null;
        let diffMins = lastActive ? Math.floor((now - lastActive.getTime())/60000) : null;
        const status = data.status || "Unknown";
        const lastSeen = lastActive ? lastActive.toLocaleTimeString() : "Never";

        const guardDiv = document.createElement('div');
        guardDiv.style.marginBottom = '14px';
        guardDiv.innerHTML = `<strong>${escapeHtml(guard)}</strong><br/>
          Status: ${escapeHtml(status)}<br/>
          Last Active: ${escapeHtml(lastSeen)}${diffMins !== null ? ` (${diffMins} min ago)` : ''}`;
        list.appendChild(guardDiv);
      });
    });
  }

  // --- Utility: Escape HTML ---
  function escapeHtml(text) {
    if (!text) return '';
    return text.replace(/[&<>"']/g, function(m) {
      switch (m) {
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
      }
    });
  }

  // --- Alarm simulation ---
  function simulateAlarm(){
    const alarmText = ALARM_MSGS[Math.floor(Math.random()*ALARM_MSGS.length)];
    addLog('alarm', 'System', alarmText);
  }

  function scheduleAlarms(){
    if(alarmTimer) clearTimeout(alarmTimer);
    // Alarms random between 3-10 minutes
    const ms = (3 + Math.random() * 7) * 60 * 1000;
    alarmTimer = setTimeout(() => {
      simulateAlarm();
      scheduleAlarms();
    }, ms);
  }

  // --- Check-in reminder ---
  function scheduleCheckIn(){
    if(checkinTimer) clearTimeout(checkinTimer);
    // Every 5 minutes for check-in prompt
    checkinTimer = setTimeout(() => {
      if(screenStack.length){
        showCheckInModal();
      }
      scheduleCheckIn();
    }, 5 * 60 * 1000);
  }

  function showCheckInModal(){
    showModal(
      "Check-in Reminder",
      "Are you okay? Please confirm you're on patrol and safe.",
      '',
      [
        {
          text: "Yes, I'm okay",
          handler: () => {
            const user = localStorage.getItem('user') || 'Unknown Guard';
            addLog('message', user, "Check-in confirmed.");
          }
        },
        {
          text: "No response",
          class: "cancel",
          handler: () => {
            const user = localStorage.getItem('user') || 'Unknown Guard';
            addLog('alert', 'System', `No check-in response from ${user}`);
          }
        }
      ]
    );
  }

  // --- Load logs from localStorage and Firebase ---
  function loadLogs(){
    let localData = localStorage.getItem('logs');
    if(localData){
      try{
        logs = JSON.parse(localData);
      }catch(e){
        logs = [];
      }
    } else {
      logs = [];
    }

    // Listen for Firebase updates and merge
    logsRef.on('value', snapshot => {
      const remoteLogs = snapshot.val();
      if(remoteLogs && Array.isArray(remoteLogs)){
        // Merge unique entries by ts+user+text to avoid duplicates
        const existingKeys = new Set(logs.map(l => l.ts + l.user + l.text));
        remoteLogs.forEach(l => {
          if(!existingKeys.has(l.ts + l.user + l.text)){
            logs.unshift(l);
          }
        });
        // Keep logs sorted by timestamp descending, limit to 200 logs max
        logs.sort((a,b) => new Date(b.ts) - new Date(a.ts));
        if(logs.length > 200) logs.length = 200;
        saveLogs();
        // Refresh screen if message board open
        if(screenStack.length && screenStack[screenStack.length-1] === messageScreen){
          renderMessages();
        }
        if(screenStack.length && screenStack[screenStack.length-1] === reportScreen){
          reportScreen(); // reload reports
        }
        if(screenStack.length && screenStack[screenStack.length-1] === statusScreen){
          statusScreen();
        }
      }
    });
  }

  // --- Load user and start app ---
  function startApp(){
    const user = localStorage.getItem('user');
    if(!user){
      screenStack = [];
      showScreen(loginScreen);
    } else {
      screenStack = [];
      showScreen(homeScreen);
    }
  }

  // --- Button handlers ---
  btnBack.onclick = () => {
    if(screenStack.length > 1){
      goBack();
    }
  };
  btnHome.onclick = () => {
    goHome();
  };
  btnMenu.onclick = () => {
    // For future menu, currently no-op
    notify("Menu button pressed (no menu implemented)");
  };

  // --- URL reset param handler ---
  function checkReset(){
    const params = new URLSearchParams(window.location.search);
    if(params.get('reset') === 'true'){
      localStorage.clear();
      location.href = window.location.pathname;
    }
  }

  // --- Initialize ---
  checkReset();
  loadLogs();
  startApp();
  scheduleAlarms();
  scheduleCheckIn();

})();
</script>

</body>
</html>
