<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RP Security Patrol App</title>
  <style>
    /* Reset and base */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      background: #00796b;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #app {
      background: #004d40;
      padding: 2rem;
      border-radius: 12px;
      width: 320px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      position: relative;
    }
    h1 {
      margin-top: 0;
      text-align: center;
      margin-bottom: 1.5rem;
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-weight: 600;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 0.8rem;
      margin-bottom: 1rem;
      border-radius: 8px;
      border: none;
      font-size: 1rem;
      font-family: inherit;
    }
    input {
      outline: none;
    }
    button {
      background: #26a69a;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    button:hover {
      background: #004d40;
    }
    #errorMessage {
      color: #ffbaba;
      font-weight: 600;
      text-align: center;
      margin-bottom: 1rem;
      display: none;
    }
    /* Modal styles */
    #modalOverlay {
      position: fixed;
      top: 0; left: 0; right:0; bottom:0;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #modal {
      background: #004d40;
      padding: 1.5rem;
      border-radius: 12px;
      width: 280px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      text-align: center;
    }
    #modal h2 {
      margin-top: 0;
    }
    #modal button {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div id="app" role="main" aria-label="RP Security Patrol App"></div>

  <div id="modalOverlay" style="display:none;" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div id="modal">
      <!-- Dynamic modal content -->
    </div>
  </div>

  <script>
    const app = document.getElementById('app');
    const modalOverlay = document.getElementById('modalOverlay');
    const modal = document.getElementById('modal');

    // Helper to get/set localStorage
    function setStorage(key, val) {
      localStorage.setItem(key, JSON.stringify(val));
    }
    function getStorage(key) {
      const val = localStorage.getItem(key);
      return val ? JSON.parse(val) : null;
    }
    function clearStorage() {
      localStorage.clear();
    }

    // --- Login Screen ---
    function showLogin() {
      app.innerHTML = `
        <h1>Guard Login</h1>
        <div id="errorMessage" role="alert" aria-live="assertive"></div>
        <form id="loginForm" autocomplete="off">
          <input id="username" name="username" type="text" placeholder="Enter guard name or ID" required aria-required="true" />
          <button type="submit">Log In</button>
        </form>
      `;

      const loginForm = document.getElementById('loginForm');
      const usernameInput = document.getElementById('username');
      const errorMessage = document.getElementById('errorMessage');

      loginForm.addEventListener('submit', e => {
        e.preventDefault();
        const username = usernameInput.value.trim();
        if (!username) {
          errorMessage.textContent = "Please enter your guard name or ID.";
          errorMessage.style.display = 'block';
          return;
        }
        errorMessage.style.display = 'none';
        // Simulate delay
        setTimeout(() => {
          setStorage('guardUsername', username);
          showMainMenu();
        }, 600);
      });
    }

    // --- Main Menu ---
    function showMainMenu() {
      const username = getStorage('guardUsername');
      app.innerHTML = `
        <h1>Welcome, ${username}</h1>
        <form id="mainMenuForm" autocomplete="off">
          <label for="locationSelect">Select Location:</label>
          <select id="locationSelect" required aria-required="true" aria-label="Location selector">
            <option value="" disabled selected>Choose a location</option>
            <option value="P404">Vancouver General Hospital</option>
            <option value="P306">Vancouver Power Plant</option>
            <option value="P403">Family Jewels & Gadget Store</option>
            <option value="P205">Toronto Dominion Bank</option>
            <option value="P1110,P200,P602">Gas & Go Franchise (multiple locations)</option>
            <option value="P217,P300">Three Guys Corporation (Restaurant & Warehouse)</option>
            <option value="P307">Fortis BC Vancouver Gas Depot</option>
            <option value="P308">Canada Post Corporation</option>
            <option value="P904,P905,P906,P907">Lake View HOA</option>
            <option value="P1104,P1105,P1107,P1108">Maple Street BIA</option>
          </select>

          <label for="patrolType">Select Patrol Type:</label>
          <select id="patrolType" required aria-required="true" aria-label="Patrol type selector">
            <option value="" disabled selected>Choose patrol type</option>
            <option value="outdoor">Outdoor Patrol</option>
            <option value="indoor">Indoor Patrol</option>
          </select>

          <button type="submit">Start Patrol</button>
        </form>
        <button id="logoutBtn" style="background:#c62828; margin-top:1rem;">Log Out</button>
      `;

      document.getElementById('mainMenuForm').addEventListener('submit', e => {
        e.preventDefault();
        const location = document.getElementById('locationSelect').value;
        const patrolType = document.getElementById('patrolType').value;
        if (!location || !patrolType) {
          alert('Please select both location and patrol type.');
          return;
        }
        setStorage('selectedLocation', location);
        setStorage('selectedPatrolType', patrolType);
        showPatrolScreen(location, patrolType);
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        clearStorage();
        showLogin();
      });
    }

    // --- Patrol Screen ---
    let alarmTimeoutId = null;
    let reportLog = [];

    const alarmMessages = [
      "Door alarm triggered at North Wing",
      "Motion detected near Loading Dock",
      "Suspicious individual reported at Parking Lot",
      "Fire alarm test in progress at Main Lobby",
      "Equipment malfunction reported at Power Plant",
      "Unauthorized access attempt at Server Room",
      "Vehicle alarm activated at Gate 3",
      "Security camera offline at East Corridor",
    ];

    function scheduleNextAlarm() {
      // Random interval between 3 to 7 minutes (in ms)
      const interval = (3 + Math.random() * 4) * 60 * 1000;
      alarmTimeoutId = setTimeout(() => {
        showAlarmPopup();
        scheduleNextAlarm();
      }, interval);
    }

    function showAlarmPopup() {
      const msg = alarmMessages[Math.floor(Math.random() * alarmMessages.length)];
      showModal(`
        <h2 id="modalTitle">ALERT</h2>
        <p>${msg}</p>
        <button id="ackAlarmBtn">Acknowledge</button>
      `);

      document.getElementById('ackAlarmBtn').addEventListener('click', () => {
        hideModal();
      });
    }

    function showModal(htmlContent) {
      modal.innerHTML = htmlContent;
      modalOverlay.style.display = 'flex';
      // Focus first button or input
      const focusable = modal.querySelector('button, input, select, textarea');
      if (focusable) focusable.focus();
    }

    function hideModal() {
      modalOverlay.style.display = 'none';
    }

    // Report form HTML
    function showReportForm() {
      showModal(`
        <h2 id="modalTitle">Report to City</h2>
        <form id="reportForm">
          <label for="reportType">Type of Report:</label>
          <select id="reportType" required aria-required="true">
            <option value="" disabled selected>Select a report type</option>
            <option value="vandalism">Vandalism</option>
            <option value="hazard">Hazard</option>
            <option value="suspicious">Suspicious Activity</option>
            <option value="other">Other</option>
          </select>
          <label for="reportDetails">Details:</label>
          <textarea id="reportDetails" rows="4" placeholder="Describe the incident..." required aria-required="true"></textarea>
          <button type="submit">Submit Report</button>
          <button type="button" id="cancelReportBtn" style="background:#c62828; margin-top:0.5rem;">Cancel</button>
        </form>
      `);

      const reportForm = document.getElementById('reportForm');
      reportForm.addEventListener('submit', e => {
        e.preventDefault();
        const type = document.getElementById('reportType').value;
        const details = document.getElementById('reportDetails').value.trim();
        if (!type || !details) {
          alert('Please fill in all fields.');
          return;
        }
        // Log report locally
        reportLog.push({
          time: new Date().toISOString(),
          type,
          details,
        });
        alert('Report submitted successfully.');
        hideModal();
      });

      document.getElementById('cancelReportBtn').addEventListener('click', () => {
        hideModal();
      });
    }

    function showPatrolScreen(location, patrolType) {
      app.innerHTML = `
        <h1>Patrol at ${location} (${patrolType})</h1>
        <p>Patrol features coming soon!</p>
        <button id="reportBtn">Report to City</button>
        <button id="backBtn" style="margin-top: 1rem;">Back to Menu</button>
        <button id="logoutBtn" style="background:#c62828; margin-top: 1rem;">Log Out</button>
      `;

      // Start scheduling alarms
      if (alarmTimeoutId) clearTimeout(alarmTimeoutId);
      scheduleNextAlarm();

      document.getElementById('reportBtn').addEventListener('click', () => {
        showReportForm();
      });

      document.getElementById('backBtn').addEventListener('click', () => {
        if (alarmTimeoutId) clearTimeout(alarmTimeoutId);
        showMainMenu();
      });

      document.getElementById('logoutBtn').addEventListener('click', () => {
        if (alarmTimeoutId) clearTimeout(alarmTimeoutId);
        clearStorage();
        showLogin();
      });
    }

    // --- Initial load ---
    window.onload = () => {
      const username = getStorage('guardUsername');
      if (username) {
        showMainMenu();
      } else {
        showLogin();
      }
    };
  </script>
</body>
</html>
