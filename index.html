<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>VSS Patrol App</title>
<style>
  /* Outer device frame container */
  body {
    margin: 0; 
    background: #111;
    display: flex; 
    justify-content: center; 
    align-items: center;
    height: 100vh;
    font-family: 'Roboto Mono', monospace, monospace;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    user-select: none;
  }
  #device {
    position: relative;
    width: 360px;
    height: 640px;
    background: #222;
    border-radius: 30px;
    box-shadow:
      inset 0 0 30px #0e3f3f,
      0 0 30px #0e3f3f,
      0 0 10px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  /* Top bezel with speaker */
  #device::before {
    content: "";
    position: absolute;
    top: 10px; left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 6px;
    background: #444;
    border-radius: 4px;
    box-shadow: 0 0 5px #0a3c3c;
    z-index: 10;
  }

  /* Status bar */
  .status-bar {
    background-color: #2c3e3e;
    color: #6bd1d1;
    font-size: 12px;
    padding: 6px 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    text-shadow: 0 0 3px #004a4a;
    user-select: none;
  }
  .status-bar span {
    font-weight: 600;
  }

  /* App content */
  #app {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    color: #aad7d7;
    background: #1a2a2a;
    font-size: 14px;
    text-shadow: 0 0 4px #004a4a;
  }

  /* Panic banner */
  #panicBanner {
    background-color: #d43c3c;
    color: #fff;
    text-align: center;
    padding: 6px 10px;
    font-weight: bold;
    font-size: 14px;
    text-shadow: 0 0 6px #7a0000;
  }

  /* Navigation bar */
  .nav-bar {
    background-color: #2c3e3e;
    color: #6bd1d1;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 8px 0;
    font-size: 20px;
    user-select: none;
    border-top: 1px solid #074d4d;
    text-shadow: 0 0 4px #004a4a;
  }
  .nav-bar button {
    background: none;
    border: none;
    color: inherit;
    font-weight: 700;
    cursor: pointer;
    transition: color 0.25s ease;
  }
  .nav-bar button:hover,
  .nav-bar button:focus {
    color: #00ffff;
    outline: none;
  }

  /* Entries in message board */
  .entry {
    border-bottom: 1px solid #073333;
    padding: 8px 0;
    line-height: 1.3;
  }
  .entry strong {
    color: #7de8e8;
    text-shadow: 0 0 4px #008b8b;
  }
  .ts {
    font-size: 11px;
    color: #3ec1c1;
    text-shadow: 0 0 3px #004a4a;
    margin-top: 4px;
  }

  /* Buttons and inputs */
  button {
    background-color: #175757;
    border: none;
    border-radius: 6px;
    color: #aad7d7;
    font-weight: 700;
    font-size: 14px;
    padding: 10px 16px;
    margin-top: 15px;
    width: 100%;
    cursor: pointer;
    box-shadow: 0 0 8px #005959;
    transition: background-color 0.3s ease;
    text-shadow: 0 0 4px #004a4a;
  }
  button:hover,
  button:focus {
    background-color: #00ffff;
    color: #003333;
    outline: none;
  }
  input, select, textarea {
    width: 100%;
    background-color: #0f2a2a;
    border: 1.5px solid #1e5f5f;
    border-radius: 6px;
    padding: 9px 12px;
    font-size: 14px;
    color: #aad7d7;
    font-family: 'Roboto Mono', monospace, monospace;
    text-shadow: 0 0 3px #004a4a;
    margin-top: 10px;
    box-sizing: border-box;
  }
  input::placeholder,
  textarea::placeholder {
    color: #3ec1c1;
    opacity: 0.7;
    font-style: italic;
  }

  /* Overlay flash for panic */
  .overlay {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background-color: rgba(212, 60, 60, 0.6);
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
    z-index: 1000;
  }
  .overlay.show {
    opacity: 1;
    pointer-events: auto;
  }

  /* In-app notification toasts */
  .notify {
    background-color: #00b3b3;
    color: #003333;
    padding: 12px 15px;
    margin-bottom: 15px;
    border-radius: 12px;
    font-weight: 700;
    box-shadow: 0 0 12px #008080;
    text-shadow: 0 0 5px #004a4a;
  }
  .notify button {
    background-color: #003333;
    color: #00ffff;
    font-weight: 700;
    border-radius: 8px;
    padding: 6px 12px;
    margin-top: 8px;
    width: auto;
  }
  .notify button:hover {
    background-color: #006666;
    color: #00e0e0;
  }

  /* Custom modal */
  #modalBackground {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1100;
  }
  #modal {
    background: #0b2c2c;
    padding: 20px 30px;
    border-radius: 20px;
    box-shadow: 0 0 20px #00cccc;
    max-width: 320px;
    width: 90%;
    color: #aad7d7;
    font-family: 'Roboto Mono', monospace;
    text-align: center;
    text-shadow: 0 0 5px #004a4a;
  }
  #modal input[type="text"],
  #modal textarea,
  #modal select {
    margin-top: 10px;
  }
  #modal button {
    margin-top: 20px;
  }

  /* Responsive scaling for tablet */
  @media (min-width: 768px) {
    #device {
      width: 600px;
      height: 1000px;
      border-radius: 40px;
      box-shadow:
        inset 0 0 40px #0e3f3f,
        0 0 40px #0e3f3f,
        0 0 15px rgba(0,0,0,0.8);
    }
  }
</style>
</head>
<body>
  <div id="device" role="main" aria-label="VSS Patrol App">
    <div class="status-bar" aria-live="polite" aria-atomic="true">
      <span id="time">--:--</span>
      <span>üîã 100%</span>
    </div>

    <div id="panicBanner" style="display:none;" role="alert" aria-live="assertive" aria-atomic="true">üö® GUARD IN PANIC MODE ‚Äî ACTION REQUIRED</div>

    <div id="app" tabindex="0">Loading‚Ä¶</div>

    <div class="nav-bar" role="navigation" aria-label="Main navigation">
      <button id="btnBack" aria-label="Back">‚óÄ</button>
      <button id="btnHome" aria-label="Home">üè†</button>
      <button id="btnMenu" aria-label="Menu">‚ò∞</button>
    </div>

    <div class="overlay" id="flashOverlay" aria-hidden="true"></div>
  </div>

  <!-- Modal -->
  <div id="modalBackground" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDesc">
    <div id="modal">
      <div id="modalTitle" style="font-weight:bold; font-size:1.2em;"></div>
      <div id="modalDesc" style="margin-top:8px; white-space: pre-wrap;"></div>
      <div id="modalContent" style="margin-top:15px;"></div>
      <button id="modalCloseBtn">Cancel</button>
    </div>
  </div>

<script src="firebase-config.js"></script>
<script>
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const logsRef = db.ref('logs');
  const guardsRef = db.ref('guards');

  // State variables
  let currentUser = "";
  let currentStatus = "Active";
  let screenStack = [];

  // DOM references
  const app = document.getElementById("app");
  const panicBanner = document.getElementById("panicBanner");
  const flashOverlay = document.getElementById("flashOverlay");
  const modalBg = document.getElementById("modalBackground");
  const modal = document.getElementById("modal");
  const modalTitle = document.getElementById("modalTitle");
  const modalDesc = document.getElementById("modalDesc");
  const modalContent = document.getElementById("modalContent");
  const modalCloseBtn = document.getElementById("modalCloseBtn");

  // Helpers
  function now() {
    return new Date().toLocaleString();
  }
  function showScreen(html) {
    app.innerHTML = html;
    app.focus();
  }
  function pushScreen(fn) {
    screenStack.push(fn);
  }
  function goBack() {
    if(screenStack.length > 0){
      const fn = screenStack.pop();
      fn();
    }
  }
  function goHome() {
    screenStack = [];
    homeScreen();
  }

  // Modal handling
  function openModal(title, desc, contentBuilder, onCancel) {
    modalTitle.textContent = title;
    modalDesc.textContent = desc || "";
    modalContent.innerHTML = "";
    if(contentBuilder) contentBuilder(modalContent);
    modalBg.style.display = "flex";
    modalCloseBtn.onclick = () => {
      modalBg.style.display = "none";
      if(onCancel) onCancel();
    };
    modalCloseBtn.focus();
  }
  function closeModal() {
    modalBg.style.display = "none";
  }

  // In-app notification toast
  function inAppNotify(msg, actionText=null, action=null) {
    const note = document.createElement("div");
    note.className = "notify";
    note.textContent = msg;
    if(actionText && action){
      const btn = document.createElement("button");
      btn.textContent = actionText;
      btn.onclick = () => {
        action();
        note.remove();
      };
      note.appendChild(btn);
    }
    app.prepend(note);
    setTimeout(() => {
      note.remove();
    }, 10000);
  }

  // Panic flash overlay
  function flashScreen(){
    flashOverlay.classList.add("show");
    setTimeout(() => flashOverlay.classList.remove("show"), 1200);
  }

  // Screens

  function loginScreen(){
    currentUser = "";
    currentStatus = "Active";
    showScreen(`
      <h2 style="text-shadow: 0 0 6px #006666;">Welcome to VSS</h2>
      <p>Please enter your name:</p>
      <input id="loginName" placeholder="Guard Name" aria-label="Enter guard name" />
      <button onclick="handleLogin()">Login</button>
    `);
  }

  function handleLogin(){
    const name = document.getElementById("loginName").value.trim();
    if(!name){
      inAppNotify("Please enter a name.");
      return;
    }
    currentUser = name;
    guardsRef.child(name).set({
      status: "Active",
      lastSeen: now(),
      location: "Logged In"
    });
    goHome();
  }

  function homeScreen(){
    showScreen(`
      <h2 style="text-shadow: 0 0 6px #006666;">Main Menu</h2>
      <button onclick="patrolScreen()">üö∂ Patrol</button>
      <button onclick="reportScreen()">üìù Submit Report</button>
      <button onclick="messageScreen()">üìã Message Board</button>
      <button onclick="triggerPanic()">üö® Panic</button>
      <button onclick="statusScreen()">üßç Set Status</button>
    `);
  }

  function patrolScreen(){
    pushScreen(homeScreen);
    showScreen(`
      <h3 style="text-shadow: 0 0 4px #005050;">Patrol</h3>
      <label for="site">Location:</label>
      <select id="site" aria-label="Select patrol location">
        <option value="VGH">Vancouver General Hospital</option>
        <option value="PowerPlant">Vancouver Power Plant</option>
        <option value="FamilyJewels">Family Jewels Outlet</option>
        <option value="TD">TD Bank</option>
        <option value="GasGo">Gas & Go</option>
        <option value="ThreeGuys">Three Guys Corp</option>
        <option value="Fortis">Fortis Gas Depot</option>
        <option value="CanadaPost">Canada Post</option>
        <option value="LakeHOA">Lake View HOA</option>
        <option value="MapleBIA">Maple Street BIA</option>
      </select>
      <label for="route">Route:</label>
      <select id="route" aria-label="Select patrol route">
        <option value="Outdoor">Outdoor</option>
        <option value="Indoor">Indoor</option>
      </select>
      <button onclick="scanTag()">üìç Scan Tag</button>
    `);
  }

  function scanTag(){
    const site = document.getElementById("site").value;
    const route = document.getElementById("route").value;
    openModal("Scan Tag", "Enter tag number (1-10):", (container) => {
      const input = document.createElement("input");
      input.type = "number";
      input.min = 1;
      input.max = 10;
      input.style.width = "100%";
      input.setAttribute("aria-label", "Tag number input");
      container.appendChild(input);

      const submitBtn = document.createElement("button");
      submitBtn.textContent = "Scan";
      submitBtn.style.marginTop = "15px";
      submitBtn.onclick = () => {
        const tag = input.value.trim();
        if(!tag || tag < 1 || tag > 10){
          inAppNotify("Please enter a valid tag number between 1 and 10.");
          return;
        }
        closeModal();
        const entry = {
          type: "scan",
          user: currentUser,
          site,
          route,
          tag,
          time: now()
        };
        logsRef.push(entry);
        inAppNotify("Tag scanned successfully.");
      };
      container.appendChild(submitBtn);
    }, () => {});
  }

  function reportScreen(){
    pushScreen(homeScreen);
    showScreen(`
      <h3 style="text-shadow: 0 0 4px #005050;">Submit Report</h3>
      <label for="reportType">Type:</label>
      <select id="reportType" aria-label="Select report type">
        <option value="Hazard">Hazard</option>
        <option value="Incident">Incident</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Other">Other</option>
      </select>
      <label for="reportDesc">Description:</label>
      <textarea id="reportDesc" rows="4" placeholder="What happened?" aria-label="Report description"></textarea>
      <button onclick="submitReport()">Submit</button>
    `);
  }

  function submitReport(){
    const type = document.getElementById("reportType").value;
    const desc = document.getElementById("reportDesc").value.trim();
    if(!desc){
      inAppNotify("Please provide a description.");
      return;
    }
    const entry = {
      type: "report",
      user: currentUser,
      reportType: type,
      description: desc,
      time: now()
    };
    logsRef.push(entry);
    inAppNotify("Report submitted.");
    goHome();
  }

  function messageScreen(){
    pushScreen(homeScreen);
    logsRef.once("value", snap => {
      let html = `<h3 style="text-shadow: 0 0 4px #005050;">Message Board</h3>`;
      const entries = snap.val();
      if(!entries) {
        html += "<p>No messages yet.</p>";
        showScreen(html);
        return;
      }
      for(let key in entries){
        const e = entries[key];
        let text = "";
        switch(e.type){
          case "scan":
            text = `scanned Tag ${e.tag} at ${e.site} (${e.route})`;
            break;
          case "report":
            text = `submitted a ${e.reportType} report: "${e.description}"`;
            break;
          case "panic":
            text = `üö® PANIC issued from ${e.location}`;
            break;
          case "checkin":
            text = `‚úÖ Responded to check-in`;
            break;
          case "alarm":
            text = `üö® System Alarm: ${e.description}`;
            break;
          default:
            text = "Unknown activity";
        }
        html += `
          <div class="entry" role="article" tabindex="0">
            <strong>${e.user}</strong>: ${text}
            <div class="ts">${e.time}</div>
          </div>`;
      }
      showScreen(html);
    });
  }

  function triggerPanic(){
    openModal("Panic Alert", "Enter your current location:", (container) => {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "Your location";
      input.style.width = "100%";
      input.setAttribute("aria-label", "Panic location input");
      container.appendChild(input);

      const submitBtn = document.createElement("button");
      submitBtn.textContent = "Send Panic";
      submitBtn.style.marginTop = "15px";
      submitBtn.onclick = () => {
        const location = input.value.trim();
        if(!location){
          inAppNotify("Please enter a location.");
          return;
        }
        closeModal();
        flashScreen();
        const entry = {
          type: "panic",
          user: currentUser,
          location,
          time: now()
        };
        logsRef.push(entry);
        guardsRef.child(currentUser).update({ status: "Panic", lastSeen: now(), location });
        panicBanner.style.display = "block";
        inAppNotify("Panic alert sent!");
      };
      container.appendChild(submitBtn);
    }, () => {});
  }

  function statusScreen(){
    pushScreen(homeScreen);
    showScreen(`
      <h3 style="text-shadow: 0 0 4px #005050;">Set Status</h3>
      <select id="statusSelect" aria-label="Select status">
        <option value="Active">Active</option>
        <option value="Armoured Transport">Armoured Transport</option>
        <option value="Break">Break</option>
      </select>
      <label for="statusLoc">Location:</label>
      <input id="statusLoc" placeholder="Where are you?" aria-label="Status location input" />
      <button onclick="updateStatus()">Update</button>
    `);
  }

  function updateStatus(){
    const status = document.getElementById("statusSelect").value;
    const location = document.getElementById("statusLoc").value.trim();
    currentStatus = status;
    guardsRef.child(currentUser).update({
      status,
      lastSeen: now(),
      location
    });
    if(status !== "Panic") panicBanner.style.display = "none";
    inAppNotify("Status updated.");
    goHome();
  }

  // Simulated alarms
  const simulatedAlarms = [
    "Suspicious customer reported near entrance.",
    "Residential alarm triggered at back lot.",
    "Loitering near fence line.",
    "Loud noise reported in parking structure.",
    "Unauthorized person near restricted zone."
  ];
  function simulateAlarm(){
    const msg = simulatedAlarms[Math.floor(Math.random() * simulatedAlarms.length)];
    const entry = {
      type: "alarm",
      user: "System",
      description: msg,
      time: now()
    };
    logsRef.push(entry);
    inAppNotify("üö® " + msg);
  }

  // Check-in cycle every 5 minutes with 1 min timeout for escalation
  const checkInInterval = 5 * 60 * 1000;
  let awaitingCheckIn = false;
  function startCheckInCycle(){
    setInterval(() => {
      if(awaitingCheckIn) {
        // Escalate panic if no response within 1 min
        triggerPanic();
      } else {
        awaitingCheckIn = true;
        inAppNotify("Check-in required. Tap below to confirm.", "‚úÖ Check In", () => {
          const entry = {
            type: "checkin",
            user: currentUser,
            time: now()
          };
          logsRef.push(entry);
          awaitingCheckIn = false;
          inAppNotify("Check-in confirmed.");
        });
      }
    }, checkInInterval);
  }

  // Reset system via URL param ?reset=true
  function checkReset(){
    const url = new URL(window.location.href);
    if(url.searchParams.get("reset") === "true"){
      logsRef.remove();
      guardsRef.remove();
      inAppNotify("All logs cleared.");
    }
  }

  // Update status bar time every second
  setInterval(() => {
    document.getElementById("time").textContent = new Date().toLocaleTimeString();
  }, 1000);

  // Navigation buttons
  document.getElementById("btnBack").onclick = () => goBack();
  document.getElementById("btnHome").onclick = () => goHome();
  document.getElementById("btnMenu").onclick = () => homeScreen();

  // Onload init
  window.onload = () => {
    loginScreen();
    checkReset();
    setInterval(simulateAlarm, Math.random() * 180000 + 180000); // 3-6 min random alarms
    startCheckInCycle();
  };
</script>
</body>
</html>
