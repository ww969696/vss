<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VSS Patrol App</title>
<style>
  @import url('https://fonts.googleapis.com/css?family=Roboto:400,500');
  * {
    box-sizing: border-box;
  }
  body,
  html {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Roboto', sans-serif;
    background: #000;
    color: #fff;
  }
  #device {
    width: 360px;
    height: 640px;
    border: 2px solid #222;
    border-radius: 16px;
    margin: 20px auto;
    position: relative;
    overflow: hidden;
    background: #f9f9f9;
    box-shadow:
      inset 0 0 10px #aaa,
      0 10px 30px rgba(0, 0, 0, 0.6);
  }
  .status-bar {
    height: 24px;
    background: #222;
    color: #ccc;
    padding: 0 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    text-shadow: 0 1px 0 #000;
    font-weight: 500;
    font-family: monospace;
  }
  #screen {
    position: absolute;
    top: 24px;
    bottom: 56px;
    left: 0;
    right: 0;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    background: #e6e6e6;
    color: #111;
  }
  .nav-bar {
    height: 56px;
    background: #222;
    display: flex;
    box-shadow: inset 0 1px 0 #444;
  }
  .nav-bar button {
    flex: 1;
    border: none;
    background: #222;
    color: #ccc;
    font-size: 24px;
    outline: none;
    cursor: pointer;
    user-select: none;
    transition: background 0.2s ease;
    font-weight: 700;
  }
  .nav-bar button:active {
    background: #555;
    color: #eee;
  }
  .app-bar {
    background: #3a5998;
    padding: 12px 16px;
    color: #fff;
    font-weight: 600;
    font-size: 18px;
    text-shadow: 0 1px 2px #000a;
    letter-spacing: 0.03em;
    box-shadow: inset 0 -2px 4px #2c4674;
  }
  .content {
    flex: 1;
    overflow-y: auto;
    padding: 14px 16px;
    background: #fff;
    color: #222;
  }
  .home-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 14px;
    padding: 10px 0;
  }
  .app-icon {
    background: #fafafa;
    border: 1px solid #999;
    border-radius: 14px;
    height: 90px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 16px;
    box-shadow: 0 1px 4px #bbb;
    cursor: pointer;
    user-select: none;
    font-weight: 600;
    transition: background 0.15s ease;
  }
  .app-icon:hover {
    background: #d9e3f0;
  }
  input,
  select,
  textarea,
  button {
    font-family: 'Roboto', sans-serif;
    font-size: 14px;
  }
  input,
  select,
  textarea {
    width: 100%;
    margin: 8px 0 12px;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1.5px solid #aaa;
    outline: none;
    transition: border-color 0.3s ease;
    color: #111;
  }
  input:focus,
  select:focus,
  textarea:focus {
    border-color: #3a5998;
    box-shadow: 0 0 8px #3a5998aa;
  }
  button {
    background: #3a5998;
    color: white;
    border: none;
    padding: 10px 14px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    box-shadow: 0 3px 8px #30518c;
    user-select: none;
  }
  button:disabled {
    background: #888;
    cursor: not-allowed;
    box-shadow: none;
  }
  button:active:not(:disabled) {
    background: #2a3f6d;
  }
  .notify {
    background: #ffeb3b;
    color: #111;
    padding: 8px 12px;
    border-radius: 8px;
    margin-bottom: 10px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 0 6px #c1b702;
  }
  .message-board .entry {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px 14px;
    margin-bottom: 14px;
    font-size: 13px;
    color: #222;
    box-shadow: 0 1px 5px #bbb;
  }
  .message-board .entry strong {
    display: block;
    font-size: 14px;
    margin-bottom: 4px;
    color: #3a5998;
  }
  .message-board .entry .ts {
    opacity: 0.6;
    font-size: 11px;
    margin-top: 6px;
    font-family: monospace;
  }
  textarea {
    resize: vertical;
    min-height: 80px;
  }
</style>
</head>
<body>
  <div id="device" role="main" aria-label="VSS Patrol App">
    <div class="status-bar" aria-live="polite" aria-atomic="true" aria-relevant="text">
      <div class="left" id="statusTime">--:--</div>
      <div class="right">üîã 85%</div>
    </div>
    <div id="screen"><div id="app" tabindex="0"></div></div>
    <div class="nav-bar" role="navigation" aria-label="Navigation Buttons">
      <button id="btnBack" aria-label="Back">‚óÄ</button>
      <button id="btnHome" aria-label="Home">‚è∫</button>
      <button id="btnMenu" aria-label="Menu">‚ò∞</button>
    </div>
  </div>

<script>
(() => {
  // Reset URL param
  const p = new URL(location).searchParams;
  if(p.get('reset') === 'true'){
    localStorage.clear();
    alert("App reset.");
    location.href = location.pathname;
  }
})();

setInterval(() => {
  const now = new Date();
  document.getElementById('statusTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'});
}, 1000);

const appEl = document.getElementById('app');
const btnBack = document.getElementById('btnBack');
const btnHome = document.getElementById('btnHome');
const btnMenu = document.getElementById('btnMenu');

const CONTRACT_SITES = [
  {name: "Vancouver General Hospital", code:"VGH"},
  {name: "Vancouver Power Plant", code:"Power Plant"},
  {name: "Family Jewels & Gadget Store", code:"FJGS"},
  {name: "Toronto Dominion Bank", code:"TDB"},
  {name: "Gas & Go Franchises", code:"Gas & Go"},
  {name: "Three Guys Corporation", code:"Three Guys"},
  {name: "Fortis BC Gas Depot", code:"Fortis BC"},
  {name: "Canada Post Corporation", code:"Canada Post"},
  {name: "Lake View HOA", code:"HOA"},
  {name: "Maple Street BIA", code:"BIA"}
];

const PATROL_TYPES = ['Outdoor', 'Indoor'];

const TAGS = {
  Outdoor: ["Tag 1", "Tag 2", "Tag 3", "Tag 4", "Tag 5"],
  Indoor: ["Tag 6", "Tag 7", "Tag 8", "Tag 9", "Tag 10"]
};

const ALARM_MSGS = [
  "Motion detected near Loading Dock",
  "Unauthorized entry at Main Gate",
  "Suspicious package detected near Parking Lot",
  "Graffiti reported near building wall",
  "Flood sensor triggered in basement",
  "Fire alarm test in Lobby",
  "Camera offline at East Corridor"
];

let logs = JSON.parse(localStorage.getItem('logs') || '[]');
let notifications = [];
let screenStack = [];

let alarmTimer = null;
let checkinTimer = null;

function saveLogs() {
  localStorage.setItem('logs', JSON.stringify(logs));
}

// Push screen to stack and show
function showScreen(screenFunc){
  screenStack.push(screenFunc);
  screenFunc();
}

// Go back in stack
function goBack(){
  if(screenStack.length > 1){
    screenStack.pop();
    screenStack[screenStack.length - 1]();
  }
}

// Go home (clear stack but keep first screen)
function goHome(){
  screenStack.splice(1);
  screenStack[0]();
}

function notify(msg){
  notifications.unshift(msg);
  const n = document.createElement('div');
  n.className = 'notify';
  n.innerText = msg;
  appEl.insertBefore(n, appEl.firstChild);
  setTimeout(() => n.remove(), 6000);
}

// LOGIN SCREEN
function loginScreen(){
  appEl.innerHTML = `
    <div class="app-bar">Login</div>
    <div class="content">
      <input id="username" placeholder="Guard name or ID" autocomplete="off" />
      <button id="loginBtn" disabled>Login</button>
    </div>
  `;
  const input = document.getElementById('username');
  const btn = document.getElementById('loginBtn');
  input.focus();
  input.addEventListener('input', () => {
    btn.disabled = input.value.trim().length === 0;
  });
  btn.onclick = () => {
    const user = input.value.trim();
    if(user){
      localStorage.setItem('user', user);
      // Set default patrol site and type if none
      if(!localStorage.getItem('patrolSite')) localStorage.setItem('patrolSite', CONTRACT_SITES[0].code);
      if(!localStorage.getItem('patrolType')) localStorage.setItem('patrolType', 'Outdoor');
      showScreen(homeScreen);
    }
  };
}

// HOME SCREEN
function homeScreen(){
  const user = localStorage.getItem('user') || 'Unknown Guard';
  appEl.innerHTML = `
    <div class="app-bar">VSS Patrol Home</div>
    <div class="content">
      <div><strong>Hello, ${user}</strong></div>
      <div class="home-grid" role="list">
        <div role="listitem" tabindex="0" class="app-icon" id="openPatrol">üõ∞Ô∏è Patrol</div>
        <div role="listitem" tabindex="0" class="app-icon" id="openReport">üìù Report</div>
        <div role="listitem" tabindex="0" class="app-icon" id="openMsgs">üìã Messages</div>
        <div role="listitem" tabindex="0" class="app-icon" id="triggerPanic">‚ùó Panic</div>
      </div>
    </div>
  `;
  document.getElementById('openPatrol').onclick = patrolScreen;
  document.getElementById('openPatrol').onkeypress = e => { if(e.key==='Enter') patrolScreen(); };
  document.getElementById('openReport').onclick = reportScreen;
  document.getElementById('openReport').onkeypress = e => { if(e.key==='Enter') reportScreen(); };
  document.getElementById('openMsgs').onclick = messageScreen;
  document.getElementById('openMsgs').onkeypress = e => { if(e.key==='Enter') messageScreen(); };
  document.getElementById('triggerPanic').onclick = triggerPanic;
  document.getElementById('triggerPanic').onkeypress = e => { if(e.key==='Enter') triggerPanic(); };
}

// PANIC FUNCTION
function triggerPanic(){
  const user = localStorage.getItem('user');
  const txt = `‚ö†Ô∏è PANIC ALERT by ${user} at ${new Date().toLocaleTimeString()}`;
  logs.unshift({type:'panic',user, text: txt, ts: new Date()});
  saveLogs();
  notify("PANIC activated!");
  goHome();
}

// PATROL SCREEN
function patrolScreen(){
  const user = localStorage.getItem('user');
  const patrolSiteCode = localStorage.getItem('patrolSite') || CONTRACT_SITES[0].code;
  const patrolType = localStorage.getItem('patrolType') || 'Outdoor';

  // Build site options
  const siteOptions = CONTRACT_SITES.map(site => {
    return `<option value="${site.code}" ${site.code === patrolSiteCode ? 'selected' : ''}>${site.name}</option>`;
  }).join('');

  // Build patrol type options: if HOA, only Outdoor; if BIA only Outdoor; else both
  let patrolTypesAllowed = PATROL_TYPES;
  if(patrolSiteCode === 'HOA' || patrolSiteCode === 'BIA') patrolTypesAllowed = ['Outdoor'];

  const patrolTypeOptions = patrolTypesAllowed.map(type => {
    return `<option value="${type}" ${type === patrolType ? 'selected' : ''}>${type}</option>`;
  }).join('');

  // Tags for current patrol type
  const currentTags = TAGS[patrolType];

  appEl.innerHTML = `
    <div class="app-bar">Patrol - ${patrolSiteCode} (${patrolType})</div>
    <div class="content">
      <label for="siteSelect"><strong>Select Site</strong></label>
      <select id="siteSelect">${siteOptions}</select>

      <label for="patrolTypeSelect"><strong>Select Patrol Type</strong></label>
      <select id="patrolTypeSelect">${patrolTypeOptions}</select>

      <label for="tagSelect"><strong>Scan Tag</strong></label>
      <select id="tagSelect">
        <option value="" disabled selected>-- Select Tag --</option>
        ${currentTags.map(t => `<option>${t}</option>`).join('')}
      </select>
      <button id="scanBtn" disabled>Scan Tag</button>
      <div id="scanResult" style="margin-top:10px; font-weight:600;"></div>
    </div>
  `;

  const siteSelect = document.getElementById('siteSelect');
  const patrolTypeSelect = document.getElementById('patrolTypeSelect');
  const tagSelect = document.getElementById('tagSelect');
  const scanBtn = document.getElementById('scanBtn');
  const scanResult = document.getElementById('scanResult');

  // Update patrol site & reset patrol type & tags when site changes
  siteSelect.onchange = () => {
    const selectedSite = siteSelect.value;
    localStorage.setItem('patrolSite', selectedSite);

    // Adjust patrol types allowed
    let newPatrolTypes = PATROL_TYPES;
    if(selectedSite === 'HOA' || selectedSite === 'BIA') newPatrolTypes = ['Outdoor'];

    // Update patrol type select options:
    patrolTypeSelect.innerHTML = newPatrolTypes.map(t => `<option value="${t}">${t}</option>`).join('');
    patrolTypeSelect.value = newPatrolTypes[0];
    localStorage.setItem('patrolType', newPatrolTypes[0]);

    // Update tags for new patrol type:
    updateTags(newPatrolTypes[0]);
    scanBtn.disabled = true;
    scanResult.textContent = '';
  };

  // When patrol type changes update tags & localstorage
  patrolTypeSelect.onchange = () => {
    const newType = patrolTypeSelect.value;
    localStorage.setItem('patrolType', newType);
    updateTags(newType);
    scanBtn.disabled = true;
    scanResult.textContent = '';
  };

  // Enable scan button if a tag selected
  tagSelect.onchange = () => {
    scanBtn.disabled = tagSelect.value === "";
    scanResult.textContent = '';
  };

  function updateTags(type){
    const newTags = TAGS[type] || [];
    tagSelect.innerHTML = `<option value="" disabled selected>-- Select Tag --</option>` +
      newTags.map(t => `<option>${t}</option>`).join('');
  }

  scanBtn.onclick = () => {
    const tag = tagSelect.value;
    if(!tag) return;
    const user = localStorage.getItem('user');
    const timeStr = new Date().toLocaleTimeString();
    const siteName = CONTRACT_SITES.find(s => s.code === localStorage.getItem('patrolSite'))?.name || 'Unknown Site';
    const msg = `Tag "${tag}" scanned by ${user} at ${siteName} (${timeStr})`;
    logs.unshift({type: 'scan', user, text: msg, ts: new Date()});
    saveLogs();
    scanResult.textContent = msg;
    notify("Tag scanned!");
  };
}

// REPORT SCREEN
function reportScreen(){
  const user = localStorage.getItem('user');
  const patrolSiteCode = localStorage.getItem('patrolSite') || CONTRACT_SITES[0].code;

  appEl.innerHTML = `
    <div class="app-bar">Submit Report</div>
    <div class="content">
      <label for="reportType"><strong>Report Type</strong></label>
      <select id="reportType">
        <option disabled selected>Select Type</option>
        <option>Incident</option>
        <option>Hazard</option>
        <option>Maintenance</option>
        <option>Other</option>
      </select>

      <label for="reportLocation"><strong>Location (optional)</strong></label>
      <input id="reportLocation" type="text" placeholder="e.g. Gate 3, Lobby" value="${patrolSiteCode}" />

      <label for="reportDetails"><strong>Details</strong></label>
      <textarea id="reportDetails" rows="5" placeholder="Describe the report..."></textarea>

      <button id="submitReport" disabled>Submit</button>
      <div id="reportMsg" style="margin-top:10px;font-weight:600;color:#3a5998;"></div>
    </div>
  `;

  const reportType = document.getElementById('reportType');
  const reportLocation = document.getElementById('reportLocation');
  const reportDetails = document.getElementById('reportDetails');
  const submitBtn = document.getElementById('submitReport');
  const reportMsg = document.getElementById('reportMsg');

  function checkEnable(){
    submitBtn.disabled = !reportType.value || reportDetails.value.trim().length === 0;
  }
  reportType.onchange = checkEnable;
  reportDetails.oninput = checkEnable;

  submitBtn.onclick = () => {
    const type = reportType.value;
    const loc = reportLocation.value.trim();
    const details = reportDetails.value.trim();
    if(!type || !details) return;
    const timeStr = new Date().toLocaleTimeString();
    const msg = `[${type}] Report by ${user}${loc ? ' @'+loc : ''}: ${details} (${timeStr})`;
    logs.unshift({type:'report', user, text: msg, ts: new Date()});
    saveLogs();
    reportMsg.textContent = 'Report submitted.';
    // Reset fields
    reportType.value = "";
    reportLocation.value = patrolSiteCode;
    reportDetails.value = "";
    submitBtn.disabled = true;
    notify("Report submitted.");
  };
}

// MESSAGE BOARD SCREEN
function messageScreen(){
  appEl.innerHTML = `
    <div class="app-bar">Messages</div>
    <div class="content message-board" id="msgBoard" tabindex="0" aria-live="polite" aria-atomic="true"></div>
  `;

  const mb = document.getElementById('msgBoard');
  if(logs.length === 0){
    mb.innerHTML = "<p>No messages yet.</p>";
  } else {
    mb.innerHTML = logs.map(e => {
      return `
        <div class="entry">
          <strong>[${e.type.toUpperCase()}] ${e.user}</strong>
          <div>${e.text}</div>
          <div class="ts">${e.ts.toLocaleTimeString()}</div>
        </div>
      `;
    }).join('');
  }
}

// RANDOM ALARM GENERATION
function scheduleAlarm(){
  clearTimeout(alarmTimer);
  alarmTimer = setTimeout(() => {
    const msg = ALARM_MSGS[Math.floor(Math.random() * ALARM_MSGS.length)];
    const user = localStorage.getItem('user') || "System";
    const timeStr = new Date().toLocaleTimeString();
    const txt = `üö® ALERT: ${msg} (${timeStr})`;
    logs.unshift({type:'alarm', user, text: txt, ts: new Date()});
    saveLogs();
    notify("ALARM: " + msg);
    scheduleAlarm();
  }, (3 + Math.random() * 4) * 60 * 1000); // every 3 to 7 minutes
}

// CHECK-IN PROMPT
function scheduleCheckin(){
  clearTimeout(checkinTimer);
  checkinTimer = setTimeout(() => {
    const user = localStorage.getItem('user');
    notify("Check-in: Are you OK?");
    // Use confirm with 1-minute timeout fallback:
    let responded = false;
    const checkinTimeout = setTimeout(() => {
      if(!responded){
        logs.unshift({type:'panic', user, text: `‚ùå Missed check-in at ${new Date().toLocaleTimeString()}`, ts: new Date()});
        saveLogs();
        notify("Missed check-in! Alert sent.");
      }
    }, 60 * 1000); // 1 minute to respond

    const ok = confirm("Check-in alert:\nAre you OK? (Please click OK within 1 minute)");
    responded = true;
    clearTimeout(checkinTimeout);

    if(ok){
      logs.unshift({type:'checkin', user, text: `‚úÖ Check-in OK at ${new Date().toLocaleTimeString()}`, ts: new Date()});
      saveLogs();
      notify("Check-in OK received.");
    } else {
      logs.unshift({type:'panic', user, text: `‚ùå Declined check-in at ${new Date().toLocaleTimeString()}`, ts: new Date()});
      saveLogs();
      notify("Declined check-in. Alert sent.");
    }
    scheduleAlarm();
    scheduleCheckin();
  }, 5 * 60 * 1000); // every 5 minutes
}

btnBack.onclick = goBack;
btnHome.onclick = goHome;
btnMenu.onclick = () => alert("Menu options coming soon.");

function init(){
  if(!localStorage.getItem('user')){
    showScreen(loginScreen);
  } else {
    showScreen(homeScreen);
  }
  scheduleAlarm();
  scheduleCheckin();
}

init();
</script>
</body>
</html>
